{{- $data := newScratch }}
{{- $service := default "github" .service }}
{{- if eq $service "github" }}
  {{- $opts := dict }}
  {{- $ghToken := getenv "GITHUB_TOKEN" }}
  {{- with $ghToken }}
    {{- $opts := dict "Authorization" (printf "Bearer %s" .) }}
  {{- end }}
  {{- with getJSON (printf "https://api.github.com/users/%s" .name) $opts }}
    {{- $data.Set "URL" .html_url }}
    {{- $data.Set "Name" .name }}
    {{- $data.Set "Repos" .public_repos }}
    {{- $data.Set "Followers" .followers }}
    {{- $data.Set "AvatarURL" (printf "%s&s=32" .avatar_url) }}
  {{- end }}
  {{/* Get stars. */}}
  {{- $stars := 0 }}
  {{- with getJSON (printf "https://api.github.com/users/%s/repos?per_page=100" .name) $opts }}
    {{- $repos := slice }}
    {{- range . }}
      {{- $repos = $repos | append (printf "repo:%s" .full_name) }}
    {{- end }}
    {{- $graphqlAPI := "https://api.github.com/graphql" }}
    {{- $graphBody := dict "query" (printf `{
      search(type: REPOSITORY, query: "%s", first: 100) {
        nodes {
          ... on Repository {
            stargazerCount
          }
        }
      }
    }` (delimit $repos " ")) }}
    {{- $graphqlOpts := newScratch }}
    {{- $graphqlOpts.Set "method" "post" }}
    {{- $graphqlOpts.Set "body" (jsonify $graphBody) }}
    {{- $graphqlOpts.SetInMap "headers" "Content-Type" "application/json" }}
    {{- with $ghToken }}
      {{- $graphqlOpts.SetInMap "headers" "Authorization" (printf "Bearer %s" .) }}
      {{- with resources.GetRemote $graphqlAPI $graphqlOpts.Values }}
        {{- with .Err }}
          {{- errorf "[github.com/hbstack/header/modules/git-org] failed to get remote resource: %s" . }}
        {{- else }}
          {{- $content := .Content | transform.Unmarshal }}
          {{- range default slice $content.data.search.nodes }}
            {{- $stars = add $stars .stargazerCount }}
          {{- end }}
        {{- end }}
      {{- else }}
        {{- errorf "[github.com/hbstack/header/modules/git-org] failed to get remote resource: %s" $graphqlAPI }}
      {{- end }}
    {{- else }}
      {{- warnf "[github.com/hbstack/header/modules/git-org] skip stars calculating since GITHUB_TOKEN is not set." }}
    {{- end }}
  {{- end }}
  {{- $data.Set "Stars" $stars }}
{{- else }}
  {{- warnf "[github.com/hbstack/header/modules/git-org] unsupported service: %s" .service }}
{{- end }}
{{- return $data.Values }}
